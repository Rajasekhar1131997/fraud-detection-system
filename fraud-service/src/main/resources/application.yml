server:
  port: 8081

spring:
  application:
    name: fraud-service
  datasource:
    url: ${DB_URL:jdbc:postgresql://localhost:5432/fraud_db}
    username: ${DB_USERNAME:fraud_user}
    password: ${DB_PASSWORD:fraud_password}
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    listener:
      observation-enabled: true
    template:
      observation-enabled: true
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring:
          json:
            add:
              type:
                headers: false
    consumer:
      group-id: ${app.kafka.consumer-group}
      auto-offset-reset: earliest
      key-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring:
          deserializer:
            key:
              delegate:
                class: org.apache.kafka.common.serialization.StringDeserializer
            value:
              delegate:
                class: org.springframework.kafka.support.serializer.JsonDeserializer
          json:
            trusted:
              packages: com.frauddetection.fraudservice.event
            value:
              default:
                type: com.frauddetection.fraudservice.event.TransactionCreatedEvent
            use:
              type:
                headers: false

app:
  kafka:
    transactions-topic: ${KAFKA_TOPIC_TRANSACTIONS:transactions}
    fraud-decisions-topic: ${KAFKA_TOPIC_FRAUD_DECISIONS:fraud-decisions}
    consumer-group: ${KAFKA_CONSUMER_GROUP:fraud-service-group}
  ml:
    base-url: ${ML_SERVICE_BASE_URL:http://localhost:8000}
    predict-path: ${ML_SERVICE_PREDICT_PATH:/predict}
    timeout-ms: ${ML_SERVICE_TIMEOUT_MS:700}
  cors:
    allowed-origins: ${APP_CORS_ALLOWED_ORIGINS:http://localhost:3000,http://127.0.0.1:3000}
  security:
    jwt:
      secret: ${APP_SECURITY_JWT_SECRET:dev-only-change-this-jwt-secret-to-a-long-random-value-32chars}
      issuer: ${APP_SECURITY_JWT_ISSUER:fraud-service}
      ttl-minutes: ${APP_SECURITY_JWT_TTL_MINUTES:60}
    users:
      - username: ${APP_SECURITY_ADMIN_USERNAME:admin}
        password: ${APP_SECURITY_ADMIN_PASSWORD:admin-change-me}
        roles:
          - ADMIN
          - ANALYST
      - username: ${APP_SECURITY_ANALYST_USERNAME:analyst}
        password: ${APP_SECURITY_ANALYST_PASSWORD:analyst-change-me}
        roles:
          - ANALYST
    rate-limit:
      enabled: ${APP_SECURITY_RATE_LIMIT_ENABLED:true}
      max-requests: ${APP_SECURITY_RATE_LIMIT_MAX_REQUESTS:120}
      window-seconds: ${APP_SECURITY_RATE_LIMIT_WINDOW_SECONDS:60}
  monitoring:
    ml:
      baseline-window-size: ${APP_MONITORING_ML_BASELINE_WINDOW_SIZE:200}
      recent-window-size: ${APP_MONITORING_ML_RECENT_WINDOW_SIZE:400}
      low-confidence-min: ${APP_MONITORING_ML_LOW_CONFIDENCE_MIN:0.40}
      low-confidence-max: ${APP_MONITORING_ML_LOW_CONFIDENCE_MAX:0.60}
      drift-alert-threshold: ${APP_MONITORING_ML_DRIFT_ALERT_THRESHOLD:0.12}
      low-confidence-alert-threshold: ${APP_MONITORING_ML_LOW_CONFIDENCE_ALERT_THRESHOLD:0.45}

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      probes:
        enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
    distribution:
      percentiles-histogram:
        fraud.processing.latency: true
        fraud.ml.inference.latency: true

resilience4j:
  circuitbreaker:
    instances:
      mlInference:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 20
        minimumNumberOfCalls: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 5
        automaticTransitionFromOpenToHalfOpenEnabled: true
  retry:
    instances:
      mlInference:
        maxAttempts: 3
        waitDuration: 200ms
        retryExceptions:
          - org.springframework.web.client.RestClientException
          - java.lang.IllegalStateException
